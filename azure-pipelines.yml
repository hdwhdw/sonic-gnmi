# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
  branches:
    include:
    - master
    - 202???
    - 201???

pr:
  branches:
    include:
    - master
    - 202???
    - 201???

variables:
  - name: BUILD_BRANCH
    ${{ if eq(variables['Build.Reason'], 'PullRequest') }}:
      value: $(System.PullRequest.TargetBranch)
    ${{ else }}:
      value: $(Build.SourceBranchName)
  - name: UNIT_TEST_FLAG
    value: 'ENABLE_TRANSLIB_WRITE=y'
  - name: DIFF_COVER_THRESHOLD
    value: 80

resources:
  repositories:
  - repository: sonic-mgmt-common
    type: github
    name: sonic-net/sonic-mgmt-common
    endpoint: sonic-net
    ref: refs/heads/$(BUILD_BRANCH)
  - repository: sonic-swss-common
    type: github
    name: sonic-net/sonic-swss-common
    endpoint: sonic-net
    ref: refs/heads/$(BUILD_BRANCH)

stages:
- stage: Build
  jobs:
  # Fast pure package testing - no SONiC dependencies needed
  - job: PureCIJob
    displayName: "Pure Package CI"
    timeoutInMinutes: 15

    pool:
      vmImage: ubuntu-22.04

    variables:
      GO_VERSION: '1.19.8'

    steps:
    - checkout: self
      clean: true
      displayName: 'Checkout code'

    - checkout: sonic-mgmt-common
      clean: true
      displayName: 'Checkout sonic-mgmt-common'

    - script: |
        wget https://go.dev/dl/go$(GO_VERSION).linux-amd64.tar.gz
        sudo tar -C /usr/local -xzf go$(GO_VERSION).linux-amd64.tar.gz
        export PATH=$PATH:/usr/local/go/bin
        go version
      displayName: 'Install Go'

    - bash: |
        set -euo pipefail
        export PATH=$PATH:/usr/local/go/bin:$(go env GOPATH)/bin
        cd sonic-gnmi
        go mod tidy
        make -f pure.mk junit-xml
      displayName: 'Run Pure Package Tests'

    - task: PublishTestResults@2
      displayName: 'Publish Pure Package Test Results'
      condition: always()
      inputs:
        testResultsFormat: 'JUnit'
        testResultsFiles: '$(System.DefaultWorkingDirectory)/sonic-gnmi/test-results/junit-pure.xml'
        failTaskOnFailedTests: true
        publishRunAttachments: true
        testRunTitle: 'Pure Package Tests'

    - task: PublishCodeCoverageResults@2
      displayName: 'Publish Pure Package Coverage'
      condition: always()
      inputs:
        codeCoverageTool: Cobertura
        summaryFileLocation: '$(System.DefaultWorkingDirectory)/sonic-gnmi/test-results/coverage-pure.xml'

    - publish: $(System.DefaultWorkingDirectory)/sonic-gnmi/test-results/coverage-pure.xml
      artifact: coverage-pure
      displayName: 'Publish pure coverage artifact'
      condition: always()

  # Memory leak testing with address sanitizer
  - job: MemoryLeakJob
    displayName: "Memory Leak Tests"
    timeoutInMinutes: 45

    pool:
      name: sonicso1ES-amd64
      vmImage: ubuntu-22.04

    variables:
      UNIT_TEST_FLAG: 'ENABLE_TRANSLIB_WRITE=y'

    container:
      image: sonicdev-microsoft.azurecr.io:443/sonic-slave-bookworm:latest

    steps:
    - checkout: self
      clean: true
      submodules: recursive
      displayName: 'Checkout code'

    - checkout: sonic-mgmt-common
      clean: true
      submodules: recursive
      displayName: 'Checkout sonic-mgmt-common'

    - checkout: sonic-swss-common
      clean: true
      submodules: recursive
      displayName: 'Checkout sonic-swss-common'

    # Install SONiC dependencies using shared template
    - template: .azure/templates/install-dependencies.yml
      parameters:
        buildBranch: $(BUILD_BRANCH)

    # Memory leak tests with JUnit XML generation

    - bash: |
        set -euo pipefail
        pushd sonic-gnmi
        make all && $(UNIT_TEST_FLAG) make check_memleak_junit
        popd
      displayName: 'Run Memory Leak Tests'

    - task: PublishTestResults@2
      displayName: 'Publish Memory Leak Test Results'
      condition: always()
      inputs:
        testResultsFormat: 'JUnit'
        testResultsFiles: '$(System.DefaultWorkingDirectory)/sonic-gnmi/test-results/junit-memleak-standard.xml'
        failTaskOnFailedTests: true
        publishRunAttachments: true
        testRunTitle: 'Memory Leak Tests'

  # Full integration testing with SONiC dependencies
  - job: build
    displayName: "build"
    timeoutInMinutes: 60

    pool:
      name: sonicso1ES-amd64
      vmImage: ubuntu-22.04

    container:
      image: sonicdev-microsoft.azurecr.io:443/sonic-slave-bookworm:latest

    steps:
    - checkout: self
      clean: true
      submodules: recursive
      fetchDepth: 0
      displayName: 'Checkout code'

    - checkout: sonic-mgmt-common
      clean: true
      submodules: recursive
      displayName: 'Checkout sonic-mgmt-common'

    - checkout: sonic-swss-common
      clean: true
      submodules: recursive
      displayName: 'Checkout sonic-swss-common'

    # Integration tests have been separated from pure package tests
    # Pure package CI now runs in the separate PureCIJob above
    # The steps below are for integration testing with SONiC dependencies
    
    # Install SONiC dependencies using shared template
    - template: .azure/templates/install-dependencies.yml
      parameters:
        buildBranch: $(BUILD_BRANCH)

    # Build sonic-mgmt-common and sonic-gnmi
    - script: |
        set -ex
        ls -l

        pushd sonic-mgmt-common
        NO_TEST_BINS=1 dpkg-buildpackage -rfakeroot -b -us -uc
        popd

        pushd sonic-gnmi
        ENABLE_TRANSLIB_WRITE=y ENABLE_NATIVE_WRITE=y dpkg-buildpackage -rfakeroot -us -uc -b -j$(nproc) && cp ../*.deb $(Build.ArtifactStagingDirectory)/
      displayName: "Build"

    # Run pure package tests for coverage (test results already published by PureCIJob)
    - bash: |
        set -euo pipefail
        pushd sonic-gnmi
        make -f pure.mk junit-xml || true
        popd
      displayName: "Run Pure Package Tests (coverage only)"

    # Run integration tests
    - bash: |
        set -euo pipefail
        pushd sonic-gnmi
        make all && $(UNIT_TEST_FLAG) make check_gotest_junit
        popd
      displayName: "Run Integration Tests"

    - task: PublishTestResults@2
      displayName: 'Publish Integration Test Results'
      condition: always()
      inputs:
        testResultsFormat: 'JUnit'
        testResultsFiles: |
          $(System.DefaultWorkingDirectory)/sonic-gnmi/test-results/junit-integration-basic.xml
          $(System.DefaultWorkingDirectory)/sonic-gnmi/test-results/junit-integration-env.xml
          $(System.DefaultWorkingDirectory)/sonic-gnmi/test-results/junit-integration-dialout.xml
        failTaskOnFailedTests: true
        publishRunAttachments: true
        testRunTitle: 'Integration Tests'

    - publish: $(Build.ArtifactStagingDirectory)/
      artifact: sonic-gnmi
      displayName: "Archive artifacts"

    - task: PublishCodeCoverageResults@2
      inputs:
        codeCoverageTool: Cobertura
        summaryFileLocation: '$(System.DefaultWorkingDirectory)/sonic-gnmi/coverage.xml'
      displayName: 'Publish coverage'

    - publish: $(System.DefaultWorkingDirectory)/sonic-gnmi/coverage.xml
      artifact: coverage-integration
      displayName: 'Publish integration coverage artifact'
      condition: always()

  - job: DiffCoverageCheck
    displayName: "Diff Coverage Check"
    dependsOn: [PureCIJob, build]
    condition: eq(variables['Build.Reason'], 'PullRequest')
    timeoutInMinutes: 10
    pool:
      vmImage: ubuntu-22.04
    steps:
    - checkout: self
      clean: true
      fetchDepth: 0

    - download: current
      artifact: coverage-pure

    - download: current
      artifact: coverage-integration

    - bash: |
        set -euo pipefail
        pip3 install --quiet diff-cover
        diff-cover \
          $(Pipeline.Workspace)/coverage-integration/coverage.xml \
          $(Pipeline.Workspace)/coverage-pure/coverage-pure.xml \
          --compare-branch origin/$(BUILD_BRANCH) \
          --src-roots . \
          --fail-under $(DIFF_COVER_THRESHOLD)
      displayName: 'Run diff-cover'
